!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3")):"function"==typeof define&&define.amd?define("d3plus-text",["exports","d3"],n):n(t.d3plus_text={},t.d3)}(this,function(t,n){"use strict";function e(t){return function(){return t}}function i(t){var e=arguments.length<=1||void 0===arguments[1]?{"font-size":10,"font-family":"sans-serif"}:arguments[1],i=n.select("body").selectAll("canvas#d3plus-text-size").data([0]);i.enter().append("canvas").attr("id","d3plus-text-size").style("position","absolute").style("left","-9999px").style("top","-9999px").style("visibility","hidden").style("display","block");var r=i.node().getContext("2d"),o=[];if("font-style"in e&&o.push(e["font-style"]),"font-variant"in e&&o.push(e["font-variant"]),"font-weight"in e&&o.push(e["font-weight"]),"font-size"in e){var u=e["font-size"]+"px";"line-height"in e&&(u+="/"+e["line-height"]+"px"),o.push(u)}return"font-family"in e&&o.push(e["font-family"]),r.font=o.join(" "),t instanceof Array?t.map(function(t){return r.measureText(t).width}):r.measureText(t).width}function r(t){return t.height||200}function o(t,n){return t.id||""+n}function u(t){return t.match(g)}function a(t){return t.text}function f(t){return t.width||200}function s(t){return t.x||0}function l(t){return t.y||0}function c(){function t(t){return t+"..."}function c(){void 0===j&&c.select(n.select("body").append("svg").style("width",window.innerWidth+"px").style("height",window.innerHeight+"px").node());var t=j.selectAll(".d3plus-text-box").data(d,A);return t.enter().append("text").attr("class","d3plus-text-box").attr("id",function(t,n){return"d3plus-text-box-"+A(t,n)}),t.attr("y",function(t,n){return H(t,n)+"px"}).attr("fill",function(t,n){return y(t,n)}).attr("text-anchor",function(t,n){return C(t,n)}).attr("font-family",function(t,n){return m(t,n)}).each(function(t,e){function r(){if(s=1,l=[""],y>a)return void(l=[]);a>d&&(a=d);var t="",n=0;u&&(f=1.1*a,B["font-size"]=a,B["line-height"]=f),c=i(W,B);var e=!0,o=!1,h=void 0;try{for(var g,m=W[Symbol.iterator]();!(e=(g=m.next()).done);e=!0){var x=g.value,v=c[W.indexOf(x)];if(v>O)break;var b=H.charAt(t.length+x.length);if(" "===b&&(x+=b),n+v>O-a){if(s++,f*s>A){if(u){if(a--,y>a){l=[];break}r()}else l[s-2]=p(l[s-2].trimRight());break}n=0,l.push(x)}else l[s-1]+=x;t+=x,n+=v," "===b&&(n+=j)}}catch(w){o=!0,h=w}finally{try{!e&&m["return"]&&m["return"]()}finally{if(o)throw h}}}function o(n){n.text(function(t){return t.trimRight()}).attr("x",q(t,e)+"px").attr("dx",_+"px").attr("dy",f+"px")}var u=b(t,e),a=u?x(t,e):w(t,e),f=u?1.1*a:M(t,e),s=1,l=[""],c=void 0,d=x(t,e),y=v(t,e),A=z(t,e),j=i(" ",B),H=R(t,e),T=C(t,e),E=F(t,e),O=S(t,e),W=k(H,e),_="start"===T?0:"end"===T?O:O/2,B={"font-family":m(t,e),"font-size":a,"line-height":f};if(A>f||u){if(u){c=i(W,B);var D=1.165+O/A*.1,G=O*A,I=n.max(c),J=n.sum(c,function(t){return t*f})*D;if(I>O||J>G){var K=Math.sqrt(G/J),L=O/I,N=n.min([K,L]);a=Math.floor(a*N)}var P=Math.floor(.8*A);a>P&&(a=P)}r(),n.select(this).attr("font-size",a+"px").style("font-size",a+"px")}var Q=s*f,U="top"===E?0:"middle"===E?A/2-Q/2:A-Q;U-=.2*f,n.select(this).transition().duration(g).attr("transform","translate(0,"+U+")");var V=n.select(this).selectAll("tspan").data(l);V.exit().transition().duration(g).attr("opacity",0).remove(),V.transition().duration(g).call(o),V.enter().append("tspan").attr("dominant-baseline","alphabetic").style("baseline-shift","0%").attr("opacity",0).call(o).transition().duration(g).delay(h).attr("opacity",1)}),c}var d=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],h=0,g=0,p=t,y=void 0,m=void 0,x=e(50),v=e(8),b=e(!1),w=void 0,z=r,A=o,M=void 0,j=void 0,k=u,R=a,C=e("start"),F=e("top"),S=f,q=s,H=l;return c.data=function(t){return arguments.length?(d=t,c):d},c.delay=function(t){return arguments.length?(h=t,c):h},c.duration=function(t){return arguments.length?(g=t,c):g},c.ellipsis=function(t){return arguments.length?(p="function"==typeof t?t:e(t),c):p},c.fontColor=function(t){return arguments.length?(y="function"==typeof t?t:e(t),c):y},c.fontFamily=function(t){return arguments.length?(m="function"==typeof t?t:e(t),c):m},c.fontMax=function(t){return arguments.length?(x="function"==typeof t?t:e(t),c):x},c.fontMin=function(t){return arguments.length?(v="function"==typeof t?t:e(t),c):v},c.fontResize=function(t){return arguments.length?(b="function"==typeof t?t:e(t),c):b},c.fontSize=function(t){return arguments.length?(w="function"==typeof t?t:e(t),void 0===M&&(M=e(Math.ceil(1.1*w()))),c):w},c.height=function(t){return arguments.length?(z="function"==typeof t?t:e(t),c):z},c.id=function(t){return arguments.length?(A="function"==typeof t?t:e(t),c):A},c.lineHeight=function(t){return arguments.length?(M="function"==typeof t?t:e(t),c):M},c.select=function(t){return arguments.length?(j=n.select(t),void 0===y&&c.fontColor(j.style("font-color")),void 0===m&&c.fontFamily(j.style("font-family")),void 0===w&&c.fontSize(parseFloat(j.style("font-size"),10)),c):j},c.split=function(t){return arguments.length?(k=t,c):k},c.text=function(t){return arguments.length?(R="function"==typeof t?t:e(t),c):R},c.textAnchor=function(t){return arguments.length?(C="function"==typeof t?t:e(t),c):C},c.verticalAlign=function(t){return arguments.length?(F="function"==typeof t?t:e(t),c):F},c.width=function(t){return arguments.length?(S="function"==typeof t?t:e(t),c):S},c.x=function(t){return arguments.length?(q="function"==typeof t?t:e(t),c):q},c.y=function(t){return arguments.length?(H="function"==typeof t?t:e(t),c):H},d.length?c():c}n="default"in n?n["default"]:n;var d="0.3.0",h=["-","/",";",":","&"],g=new RegExp("[^\\s\\"+h.join("\\")+"]+\\"+h.join("?\\")+"?","g");t.version=d,t.box=c,t.width=i});